---
title: "01 16s Analysis Report"
output:
  pdf_document:
    df_print: kable
  html_document:
    df_print: kable
    smart: false
---

```{r init renv, message=FALSE, warning=FALSE, include=FALSE}
#library(renv)
#renv::isolate()
#renv::settings$snapshot.type("all")
#renv::restore()
```



```{r parse item of interest and make outdir for figures, echo=FALSE, message=FALSE, warning=FALSE}
#this may be required for each file
#item of interest, comes from bash and python script that orchestrates everything
#wd <- readLines("work_dir.txt")
#setwd(wd)
wd <- getwd()
print(wd)
ioi <- readLines(paste0("item_of_interest.csv"))
ioi<-as.character(ioi)

outdir_name <- "barplots"
if(!dir.exists(outdir_name)) {dir.create(outdir_name)}
outdir <- outdir_name
```

## 1 Species Distribution 

```{r import data into Microbiome Analyst Format, echo=FALSE, message=FALSE, warning=FALSE}
library(MicrobiomeAnalystR)
library(dplyr)
library(tidyr)


prepend <- "results/"
mbadir <- "microbiome_analyst_tmp"

if (!file.exists(mbadir)){
  dir.create(mbadir)
}


mbSet <- Init.mbSetObj()
mbSet<-SetModuleType(mbSet, "mdp")

options(bitmapType='cairo')
level = "Phylum"

#import ASV table from ampliseq analysis and write out properly fomatted one

new_table_file <- paste0(prepend,"qiime2/abundance_tables/feature-table.tsv")
new_table <- read.csv(new_table_file,sep='\t', skip=1)
new_table_df <- data.frame(new_table)
colnames(new_table_df)[1] <- "#NAME"
write.table(new_table_df,file = paste0(mbadir,"/ASV-tab.txt"),sep='\t',row.names = F)

mbSet <- Read16SAbundData(mbSet,paste0(mbadir,"/ASV-tab.txt"),"text",'SILVA','T')




#import taxonomy table from ampliseq analysis
new_tax_file <- paste0(prepend,"dada2/ASV_tax_species.tsv")
new_tax <- read.csv(new_tax_file,sep='\t')
new_tax_df <- data.frame(new_tax)
colnames(new_tax_df)[1] <- "#TAXONOMY"
new_tax_df <- new_tax_df %>%
  select(-c(Domain,confidence,sequence))
write.table(new_tax_df,file = paste0(mbadir,"/ASV_tax_species.txt"),sep='\t',row.names = F,quote = F)

mbSet <- Read16STaxaTable(mbSet, paste0(mbadir,"/ASV_tax_species.txt"))

#import rooted tree from ampliseq analysis 
new_tree_file <- paste0(prepend,"qiime2/phylogenetic_tree/tree.nwk")

mbSet <- ReadTreeFile(mbSet,new_tree_file)

#import metadata file 
new_metadata_file <- paste0(prepend,"all_days_sbm_cec_nf_treatment_metadata.tsv")
new_metadata <- read.csv(new_metadata_file,sep = '\t')
new_metadata_df <- data.frame(new_metadata)
colnames(new_metadata_df)[1]<-"#NAME"
write.table(new_metadata_df,file = paste0(mbadir,"/metadata.txt"),sep='\t',row.names = F,quote = F)

mbSet <- ReadSampleTable(mbSet,paste0(mbadir,"/metadata.txt"))

mbSet<-SanityCheckData(mbSet, "txt")

#TODO get this into the figure directory
mbSet<-PlotLibSizeView(mbSet, "norm_libsizes_0","png")

mbSet<-CreatePhyloseqObj(mbSet, "text","SILVA","F")

#Abundance filter (should have been handled by QIIME2) default 4, 0.2
mbSet<-ApplyAbundanceFilter(mbSet, "prevalence", 0, 0.0)

#Varience filter (probably should be handled by QIIME2) default 0.1
mbSet<-ApplyVarianceFilter(mbSet, "iqr", 0.0)

# Data Normalization (maybe handled by QIIME2)
mbSet<-PerformNormalization(mbSet, "none", "none", "none")

```

### 1.1 Relative Abundance of Top 10 Phyla

```{r stacked bar chart at Phylum level, echo=FALSE, fig.height=12, fig.width=18, message=FALSE, warning=FALSE}
library(MicrobiomeAnalystR)
library(knitr)

select_top <- 10
taxa_level <- "Phylum"
#ioi <- 'condition'
dpi <- 160
dpi2 <- 72
topN <- length(unique(mbSet$dataSet$taxa_table[,taxa_level]))

if (topN < select_top){
  select_top <- topN
}

# Merges taxa with count lower than 10 relative abundance
mbSet<-PlotTaxaAundanceBar(mbSet, paste0(outdir,"/taxa_alpha_merge_relative_",taxa_level),taxa_level,ioi, "none", "barnorm",10, "set3","sum",10, "bottom", "F", "png",dpi = dpi)

# Shows top 10 taxa (Will error out if less than 10) relative abundance
#TODO Create some code to check for top 10
mbSet<-PlotTaxaAundanceBar(mbSet, paste0(outdir,"/taxa_alpha_subset_relative_",taxa_level),taxa_level,ioi, "none", "barnorm",10, "set3","sum",select_top, "top", "F", "png",dpi = dpi)

# Merges taxa with counts lower than 10 absolute abundance
mbSet<-PlotTaxaAundanceBar(mbSet, paste0(outdir,"/taxa_alpha_merge_absolute_",taxa_level),taxa_level,ioi, "none", "barraw",10, "set3","sum",10, "bottom", "F", "png",dpi = dpi)

# Subsets top 10 taxa absolute
mbSet<-PlotTaxaAundanceBar(mbSet, paste0(outdir,"/taxa_alpha_subset_absolute_",taxa_level),taxa_level,ioi, "none", "barraw",10, "set3","sum",select_top, "top", "F", "png",dpi = dpi)

# merge taxa with count lower than 10 relative and merges item of interest
mbSet <- mbSet<-PlotTaxaAbundanceBarSamGrp(mbSet, paste0(outdir,"/taxa_alpha_merge_relative_ioi_",taxa_level),taxa_level, ioi, "none", "barnorm",10,"set3","sum", 10, "bottom", "F", "png",dpi = dpi2)

# subsets top 10/N taxa relative and merges item of interest
mbSet <- mbSet<-PlotTaxaAbundanceBarSamGrp(mbSet, paste0(outdir,"/taxa_alpha_subset_relative_ioi_",taxa_level),taxa_level,ioi, "none", "barnorm",10,"set3","sum", select_top, "top", "F", "png",dpi=dpi2)

knitr::include_graphics("Figures/taxa_alpha_merge_relative_Phylum.png")
knitr::include_graphics("Figures/taxa_alpha_subset_relative_Phylum.png")
knitr::include_graphics("Figures/taxa_alpha_merge_absolute_Phylum.png")
knitr::include_graphics("Figures/taxa_alpha_subset_absolute_Phylum.png")
knitr::include_graphics("Figures/taxa_alpha_merge_relative_ioi_Phylum.png")
knitr::include_graphics("Figures/taxa_alpha_subset_relative_ioi_Phylum.png")
```

![Stacked Bar Plot of Relative Abundance Subsetted Phyla Over 10 count](Figures/taxa_alpha_merge_relative_Phylum.png)
![Stacked Bar Plot of Relative Abundance top 10 Phyla](Figures/taxa_alpha_subset_relative_Phylum.png)
![Stacked Bar Plot of Relative Abundance Merged Phyla Over 10 count](Figures/taxa_alpha_merge_absolute_Phylum.png)
![Stacked Bar Plot of Absolute Abundance top 10 Phyla](Figures/taxa_alpha_subset_absolute_Phylum.png)

![Stacked Bar Plot of Relative Abundance Merged Phyla over 10 Count Item of interest](Figures/taxa_alpha_merge_relative_ioi_Phylum.png)


![Stacked Bar Plot of Relative Abundance top 10 Phyla Merged Item of interest](Figures/taxa_alpha_subset_relative_ioi_Phylum.png)

### 1.2 Relative Abundance of Top 10 Genera

```{r stacked bar chart at Genus level, echo=FALSE, fig.height=12, fig.width=18, message=FALSE, warning=FALSE}
library(MicrobiomeAnalystR)

select_top <- 10
taxa_level <- "Genus"
#ioi <- 'condition'
dpi <- 160
topN <- length(unique(mbSet$dataSet$taxa_table[,taxa_level]))

if (topN < select_top){
  select_top <- topN
}

# Merges taxa with count lower than 10 relative abundance
mbSet<-PlotTaxaAundanceBar(mbSet, paste0(outdir,"/taxa_alpha_merge_relative_",taxa_level),taxa_level,ioi, "none", "barnorm",10, "set3","sum",10, "bottom", "F", "png",dpi = dpi)

# Shows top 10 taxa (Will error out if less than 10) relative abundance
#TODO Create some code to check for top 10
mbSet<-PlotTaxaAundanceBar(mbSet, paste0(outdir,"/taxa_alpha_subset_relative_",taxa_level),taxa_level,ioi, "none", "barnorm",10, "set3","sum",select_top, "top", "F", "png",dpi = dpi)

# Merges taxa with counts lower than 10 absolute abundance
mbSet<-PlotTaxaAundanceBar(mbSet, paste0(outdir,"/taxa_alpha_merge_absolute_",taxa_level),taxa_level,ioi, "none", "barraw",10, "set3","sum",10, "bottom", "F", "png",dpi = dpi)

# Subsets top 10 taxa absolute
mbSet<-PlotTaxaAundanceBar(mbSet, paste0(outdir,"/taxa_alpha_subset_absolute_",taxa_level),taxa_level,ioi, "none", "barraw",10, "set3","sum",select_top, "top", "F", "png",dpi = dpi)

# merge taxa with count lower than 10 relative and merges item of interest
mbSet <- mbSet<-PlotTaxaAbundanceBarSamGrp(mbSet, paste0(outdir,"/taxa_alpha_merge_relative_ioi_",taxa_level),taxa_level, ioi, "none", "barnorm",10,"set3","sum", 10, "bottom", "F", "png",dpi=dpi2)

# subsets top 10/N taxa relative and merges item of interest
mbSet <- mbSet<-PlotTaxaAbundanceBarSamGrp(mbSet, paste0(outdir,"/taxa_alpha_subset_relative_ioi_",taxa_level),taxa_level,ioi, "none", "barnorm",10,"set3","sum", select_top, "top", "F", "png",dpi=dpi2)

knitr::include_graphics("Figures/taxa_alpha_merge_relative_Genus.png")
knitr::include_graphics("Figures/taxa_alpha_subset_relative_Genus.png")
knitr::include_graphics("Figures/taxa_alpha_merge_absolute_Genus.png")
knitr::include_graphics("Figures/taxa_alpha_subset_absolute_Genus.png")
knitr::include_graphics("Figures/taxa_alpha_merge_relative_ioi_Genus.png")
knitr::include_graphics("Figures/taxa_alpha_subset_relative_ioi_Genus.png")
```

![Stacked Bar Plot of Relative Abundance of Merged Genera Over 10 count](Figures/taxa_alpha_merge_relative_Genus.png)
![Stacked Bar Plot of Relative Abundance top 10 Genera](Figures/taxa_alpha_subset_relative_Genus.png)
![Stacked Bar Plot of Absolute Abundance of Merged Genera Over 10 count](Figures/taxa_alpha_merge_absolute_Genus.png)
![Stacked Bar Plot of Absolute Abundance top 10 Genera](Figures/taxa_alpha_subset_absolute_Genus.png)

![Stacked Bar Plot of Relative Abundance Merged Phyla over 10 Count Item of interest](Figures/taxa_alpha_merge_relative_ioi_Genus.png)

![Stacked Bar Plot of Relative Abundance top 10 Phyla Merged Item of interest](Figures/taxa_alpha_subset_relative_ioi_Genus.png)

### 1.3 Relative Abundance of Top 10 Species

```{r stacked bar chart at Species level, echo=FALSE, fig.height=12, fig.width=18, message=FALSE, warning=FALSE}
library(MicrobiomeAnalystR)

select_top <- 10
taxa_level <- "Species"
#ioi <- 'condition'
dpi <- 160
topN <- length(unique(mbSet$dataSet$taxa_table[,taxa_level]))

if (topN < select_top){
  select_top <- topN
}

# Merges taxa with count lower than 10 relative abundance
mbSet<-PlotTaxaAundanceBar(mbSet, paste0(outdir,"/taxa_alpha_merge_relative_",taxa_level),taxa_level,ioi, "none", "barnorm",10, "set3","sum",10, "bottom", "F", "png",dpi = dpi)

# Shows top 10 taxa (Will error out if less than 10) relative abundance
#TODO Create some code to check for top 10
mbSet<-PlotTaxaAundanceBar(mbSet, paste0(outdir,"/taxa_alpha_subset_relative_",taxa_level),taxa_level,ioi, "none", "barnorm",10, "set3","sum",select_top, "top", "F", "png",dpi = dpi)

# Merges taxa with counts lower than 10 absolute abundance
mbSet<-PlotTaxaAundanceBar(mbSet, paste0(outdir,"/taxa_alpha_merge_absolute_",taxa_level),taxa_level,ioi, "none", "barraw",10, "set3","sum",10, "bottom", "F", "png",dpi = dpi)

# Subsets top 10 taxa absolute
mbSet<-PlotTaxaAundanceBar(mbSet, paste0(outdir,"/taxa_alpha_subset_absolute_",taxa_level),taxa_level,ioi, "none", "barraw",10, "set3","sum",select_top, "top", "F", "png",dpi = dpi)

# merge taxa with count lower than 10 relative and merges item of interest
mbSet <- mbSet<-PlotTaxaAbundanceBarSamGrp(mbSet, paste0(outdir,"/taxa_alpha_merge_relative_ioi_",taxa_level),taxa_level, ioi, "none", "barnorm",10,"set3","sum", 10, "bottom", "F", "png",dpi=dpi2)

# subsets top 10/N taxa relative and merges item of interest
mbSet <- mbSet<-PlotTaxaAbundanceBarSamGrp(mbSet, paste0(outdir,"/taxa_alpha_subset_relative_ioi_",taxa_level),taxa_level,ioi, "none", "barnorm",10,"set3","sum", select_top, "top", "F", "png",dpi=dpi2)

knitr::include_graphics("Figures/taxa_alpha_merge_relative_Species.png")
knitr::include_graphics("Figures/taxa_alpha_subset_relative_Species.png")
knitr::include_graphics("Figures/taxa_alpha_merge_absolute_Species.png")
knitr::include_graphics("Figures/taxa_alpha_subset_absolute_Species.png")
knitr::include_graphics("Figures/taxa_alpha_merge_relative_ioi_Species.png")
knitr::include_graphics("Figures/taxa_alpha_subset_relative_ioi_Species.png")
```

![Stacked Bar Plot of Relative Abundance Subsetted Species Over 10 count](Figures/taxa_alpha_merge_relative_Species.png)
![Stacked Bar Plot of Relative Abundance top 10 Species](Figures/taxa_alpha_subset_relative_Species.png)
![Stacked bar plot absolute of merged Species with count less than 10 ](Figures/taxa_alpha_merge_absolute_Species.png)
![Stacked bar plot absolute of top 10 subsetted Species ](Figures/taxa_alpha_subset_absolute_Species.png)

![Stacked Bar Plot of Relative Abundance Merged Phyla over 10 Count Item of interest](Figures/taxa_alpha_merge_relative_ioi_Species.png)

![Stacked Bar Plot of Relative Abundance top 10 Phyla Merged Item of interest](Figures/taxa_alpha_subset_relative_ioi_Species.png)